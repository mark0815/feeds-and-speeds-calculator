{% load i18n %}
<html>

<head>
    <title>{% trans "Calculator" %}</title>
    <script src="https://d3js.org/d3.v5.js"></script>
    <style type="text/css">
        /* 13. Basic Styling with CSS */

        /* Style the lines by removing the fill and applying a stroke */
        .line {
            fill: none;
            stroke: #ffab00;
            stroke-width: 3;
        }

        .overlay {
            fill: none;
            pointer-events: all;
        }

        /* Style the dots by assigning a fill and stroke */
        .dot {
            fill: #ffab00;
            stroke: #fff;
        }

        .focus circle {
            fill: none;
            stroke: steelblue;
        }

        .axis text {
            fill: #2b2929;
            font-family: Georgia;
            font-size: 120%;
        }
    </style>
</head>

<body>
    <h1>{% trans "Calculator" %}</h1>

    <select id="machineSelectButton">
        <option value="-">-</option>
    </select>
    <br />
    <select id="materialSelectButton">
        <option value="-">-</option>
    </select>
    <br />
    <select id="toolSelectButton">
        <option value="-">-</option>
    </select>

    <hr />

    <span id="selectedContext"></span>

    <hr />

    <div id='vis-container'></div>

    <script type="text/javascript">
        var selectedMachine;
        var selectedTool;
        var selectedMaterial;
        var selectedCuttingSpeed;

        d3.json("/api/machine/").then((data) => {
            d3.select("#machineSelectButton")
                .selectAll('options')
                .data(data)
                .enter()
                .append('option')
                .text(function (d) { return d.name; })
                .attr("value", function (d) { return d.id; })
        });
        d3.select("#machineSelectButton").on("change", function () {
            selectedMachineId = d3.select(this).property('value')
            d3.json("/api/machine/" + selectedMachineId).then((data) => {
                selectedMachine = data;
            });
        })
        d3.json("/api/material/").then((data) => {
            d3.select("#materialSelectButton")
                .selectAll('options')
                .data(data)
                .enter()
                .append('option')
                .text(function (d) { return d.name; })
                .attr("value", function (d) { return d.id; })
        });
        d3.json("/api/tool/").then((data) => {
            d3.select("#toolSelectButton")
                .selectAll('options')
                .data(data)
                .enter()
                .append('option')
                .text(function (d) { return d.name; })
                .attr("value", function (d) { return d.id; })
        });


        var updateChart = function () {
            var margin = { top: 50, right: 50, bottom: 50, left: 50 }
                , width = window.innerWidth - margin.left - margin.right // Use the window's width 
                , height = window.innerHeight - margin.top - margin.bottom; // Use the window's height

            var n = 51;
            var xScale = d3.scaleLinear().domain([0, n - 1]).range([0, width]);
            var yScale = d3.scaleLinear().domain([0, 1]).range([height, 0]);
            var line = d3.line()
                .x(function (d, i) { return xScale(i); })
                .y(function (d) { return yScale(d.y); })
            //.curve(d3.curveMonotoneX);

            var dataset = d3.range(n).map(function (d) { return { "y": d3.randomUniform(1)() } });



            var svg = d3.select("div#vis-container").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(xScale)) // Create an axis component with d3.axisBottom
                // label
                .append("text").attr("dy", ".75em").attr("y", 25).attr("x", 10).style("text-anchor", "end").text("Ae");

            // 4. Call the y axis in a group tag
            svg.append("g")
                .attr("class", "y axis")
                .call(d3.axisLeft(yScale))
                // label
                .append("text").attr("transform", "rotate(-90)").attr("dy", ".75em").attr("y", -45).style("text-anchor", "end").text("Frequency");

            // 9. Append the path, bind the data, and call the line generator 
            svg.append("path")
                .datum(dataset) // 10. Binds data to the line 
                .attr("class", "line") // Assign a class for styling 
                .attr("d", line); // 11. Calls the line generator 

            svg.selectAll(".dot")
                .data(dataset)
                .enter().append("circle") // Uses the enter().append() method
                .attr("class", "dot") // Assign a class for styling
                .attr("cx", function (d, i) { return xScale(i) })
                .attr("cy", function (d) { return yScale(d.y) })
                .attr("r", 5)
                .on("mouseover", function (a, b, c) {
                    console.log(a)
                    this.attr('class', 'focus')
                })
                .on("mouseout", function () { })
        }

        var updateDisplay = function () {
            selectedContext = "Feed per tooth:" + selectedCuttingSpeed['feed_per_tooth'] +
                " Cutting speed:" + selectedCuttingSpeed['cutting_speed'] +
                " Machine:" + selectedMachine['name'] +
                " Tool:" + selectedTool['name']
            d3.select("#selectedContext").html(selectedContext);

            //updateChart();

        }

        var loadCuttingSpeeds = function () {
            var selectedMaterialId = d3.select("#materialSelectButton").property("value");
            var selectedToolId = d3.select("#toolSelectButton").property("value");
            if (selectedMaterialId == '-' || selectedToolId == '-') {
                return;
            }
            d3.json("/api/material/" + selectedMaterialId).then((data) => {
                selectedMaterial = data;
            });
            d3.json("/api/tool/" + selectedToolId).then((data) => {
                selectedTool = data;
            });
            d3.json("/api/cutting_speed/?tool=" + selectedToolId + "&material=" + selectedMaterialId).then((cutting_speeds) => {
                selectedCuttingSpeed = cutting_speeds[0];
                updateDisplay();
            });
        }

        d3.select("#materialSelectButton").on("change", function (d) {
            loadCuttingSpeeds();
        });
        d3.select("#toolSelectButton").on("change", function (d) {
            loadCuttingSpeeds();
        });


        updateChart();



    </script>
</body>

</html>