{% load i18n %}
<html>

<head>
    <title>{% trans "Calculator" %}</title>
    <script src="https://d3js.org/d3.v5.js"></script>
    <style type="text/css">
        /* 13. Basic Styling with CSS */

        /* Style the lines by removing the fill and applying a stroke */
        .line_rpm {
            fill: none;
            stroke-width: 3;
            stroke: #ffab00;
        }
        .line_feed {
            fill: none;
            stroke-width: 3;
            stroke: #ffabee;
        }

        .overlay {
            fill: none;
            pointer-events: all;
        }

        /* Style the dots by assigning a fill and stroke */
        .dot_rpm {
            stroke: #fff;
            fill: #ffab00;
        }
        .dot_feed {
            stroke: #fff;
            fill: #ffabee;
        }

        .focus circle {
            fill: none;
            stroke: steelblue;
        }

        .axis text {
            fill: #2b2929;
            font-family: Georgia;
            font-size: 120%;
        }
    </style>
</head>

<body>
    <h1>{% trans "Calculator" %}</h1>

    <select id="machineSelectButton">
        <option value="-">-</option>
    </select>
    <br />
    <select id="materialSelectButton">
        <option value="-">-</option>
    </select>
    <br />
    <select id="toolSelectButton">
        <option value="-">-</option>
    </select>


    <hr />

    <span id="selectedContext"></span>

    <hr />

    <div id='vis-container'></div>

    <script type="text/javascript">
        var selectedMachine; // id, name, max_rpm, max_cutting_speed
        var selectedTool;
        var selectedMaterial;
        var selectedCuttingSpeed;

        /*var cut_settings = {
            'tool': {
                'name': '8mm 3 Flute VHM Aluminum',
                'diameter': 8.0,
                'fz_factor_at_one_ae': 1.0,
                'vc_factor_at_one_ae': 0.75,
                'flute_length': 19.0,
                'flute_count': 3
            },
            'material': {
                'name': 'Al MgSi (6060)',
                'kc_1_1': 830.0,
                'mc': 0.23
            },
            'feed_per_tooth': 0.02,
            'cutting_speed': 230.0
        }*/
        //machine = {
        //    'max_rpm': 7500,
        //    'max_cutting_speed': 600.0
        //}

        d3.json("/api/machine/").then((data) => {
            d3.select("#machineSelectButton")
                .selectAll('options')
                .data(data)
                .enter()
                .append('option')
                .text(function (d) { return d.name; })
                .attr("value", function (d) { return d.id; })
        });
        d3.json("/api/material/").then((data) => {
            d3.select("#materialSelectButton")
                .selectAll('options')
                .data(data)
                .enter()
                .append('option')
                .text(function (d) { return d.name; })
                .attr("value", function (d) { return d.id; })
        });
        d3.json("/api/tool/").then((data) => {
            d3.select("#toolSelectButton")
                .selectAll('options')
                .data(data)
                .enter()
                .append('option')
                .text(function (d) { return d.name; })
                .attr("value", function (d) { return d.id; })
        });

        var fzAdjusted = function (cut_settings, ae) {
            var ae_factor = Math.min(1, ae / cut_settings.tool.diameter);
            var fz_factor = 1 - ((1 - cut_settings.tool.fz_factor_at_one_ae) * ae_factor);
            return cut_settings.feed_per_tooth * fz_factor;
        }

        var vcAdjusted = function (tool_diameter, tool_vc_factor_at_one_ae, cutting_speed, ae) {
            ae_factor = Math.min(1, (ae / tool_diameter))
            vc_factor = 1 - ((1 - tool_vc_factor_at_one_ae) * ae_factor)
            result = cutting_speed * vc_factor
            //console.log(result)
            return result
        }

        var calculateFeedsAndSpeeds = function (machine, cut_settings, ae_percent) {
            //console.log(cut_settings)
            ae = cut_settings.tool.diameter * ae_percent;
            flute_count = cut_settings.tool.flute_count;
            feed_per_tooth = fzAdjusted(cut_settings, ae);
            cutting_speed = vcAdjusted(cut_settings.tool.diameter, cut_settings.tool.vc_factor_at_one_ae, cut_settings.cutting_speed, ae);

            rpm_calculated = (cutting_speed * 1000) / (Math.PI * cut_settings.tool.diameter);
            feed_calculated = rpm_calculated * feed_per_tooth * flute_count;

            rpm_max = Math.min(rpm_calculated, machine.max_rpm)
            feed_at_rpm_max = rpm_max * feed_per_tooth * flute_count
            rpm_final = feed_at_rpm_max / (feed_per_tooth * flute_count)
            return {
                "rpm": rpm_final,
                "feed": feed_at_rpm_max
            }
        }
        
        var rpmLine;
        var feedLine;
        var dataset = [];
        createChart = function() {
            var margin = { top: 50, right: 50, bottom: 50, left: 50 }
                , width = 800 - margin.left - margin.right
                , height = 600 - margin.top - margin.bottom;

            var aeScale = d3.scaleLinear().domain([0, 1]).range([0, width]);
            var rpmScale = d3.scaleLinear().domain([0, selectedMachine['max_rpm']]).range([height, 0]);
            var feedScale = d3.scaleLinear().domain([0, selectedMachine['max_cutting_speed']]).range([height, 0]);
            rpmLine = d3.line()
                .x(function (d, i) {
                    return aeScale(d.ae);
                })
                .y(function (d) {
                    return rpmScale(d.rpm);
                });
            feedLine = d3.line()
                .x(function (d, i) {
                    return aeScale(d.ae);
                })
                .y(function (d) {
                    return feedScale(d.feed);
                });

            var svg = d3.select("div#vis-container").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(aeScale)) // Create an axis component with d3.axisBottom
                // label
                .append("text").attr("dy", ".75em").attr("y", 25).attr("x", 10).style("text-anchor", "end").text("Ae");

            // 4. Call the y axis in a group tag
            svg.append("g")
                .attr("class", "y axis")
                .call(d3.axisLeft(rpmScale))
                // label
                .append("text").attr("transform", "rotate(-90)").attr("dy", ".75em").attr("y", -45).style("text-anchor", "end").text("RPM");

            // 4. Call the y axis in a group tag
            svg.append("g")
                .attr("class", "y axis")
                .attr("transform", "translate(" + width + " ,0)")	
                .call(d3.axisRight(feedScale))
                // label
                .append("text").attr("transform", "rotate(-90)").attr("dy", ".75em").attr("y", 40).style("text-anchor", "end").text("Feed");

            svg.append("path")
                //.datum(dataset) // 10. Binds data to the line 
                .attr("class", "line_rpm") // Assign a class for styling 
                .attr("d", rpmLine(dataset)); // 11. Calls the line generator 

            svg.append("path")
                //.datum(dataset) // 10. Binds data to the line 
                .attr("class", "line_feed") // Assign a class for styling 
                .attr("d", feedLine(dataset)); // 11. Calls the line generator 
            
            //svg.selectAll(".dot")
            //    .data(dataset)
            //    .enter().append("circle") // Uses the enter().append() method
            //    .attr("class", "dot_rpm") // Assign a class for styling
            //    .attr("cx", function (d, i) { return aeScale(d.ae) })
            //    .attr("cy", function (d) { return rpmScale(d.rpm) })
            //    .attr("r", 5)
            //    .on("mouseover", function (a, b, c) {
            //        this.attr('class', 'focus')
            //    })
            //    .on("mouseout", function () { })
        }

        var updateChart = function () {
            var svg = d3.select("div#vis-container").transition();

            dataset = d3.range(0.01, 1.01, 0.01).map(function (d) {
                v = calculateFeedsAndSpeeds(selectedMachine, selectedCuttingSpeed, d)
                return {
                    "ae": d,
                    "rpm": v.rpm,
                    "feed": v.feed
                }
            });

            svg.select(".line_rpm")   // change the line
            .duration(750)
            .attr("d", rpmLine(dataset));

            svg.select(".line_feed")   // change the line
            .duration(750)
            .attr("d", feedLine(dataset));
            

            // 9. Append the path, bind the data, and call the line generator 
            //svg.append("path")
            //    .datum(dataset) // 10. Binds data to the line 
            //    .attr("class", "line_rpm") // Assign a class for styling 
            //    .attr("d", rpmLine); // 11. Calls the line generator 

            // 9. Append the path, bind the data, and call the line generator 
            //svg.append("path")
            //    .datum(dataset) // 10. Binds data to the line 
            //    .attr("class", "line_feed") // Assign a class for styling 
            //    .attr("d", feedLine); // 11. Calls the line generator 
        }

        var loadCuttingSpeeds = function () {
            var selectedMaterialId = d3.select("#materialSelectButton").property("value");
            var selectedToolId = d3.select("#toolSelectButton").property("value");
            if (selectedMaterialId == '-' || selectedToolId == '-') {
                return;
            }
            d3.json("/api/material/" + selectedMaterialId).then((data) => {
                selectedMaterial = data;
            });
            d3.json("/api/tool/" + selectedToolId).then((data) => {
                selectedTool = data;
            });
            d3.json("/api/cutting_speed/?tool=" + selectedToolId + "&material=" + selectedMaterialId).then((cutting_speeds) => {
                d3.json("/api/cutting_speed_calculation_data/"+cutting_speeds[0].id+"/").then((data) => {
                    selectedCuttingSpeed = data
                    updateChart();
                });
            });
        }

        d3.select("#machineSelectButton").on("change", function () {
            selectedMachineId = d3.select(this).property('value')
            d3.json("/api/machine/" + selectedMachineId).then((data) => {
                selectedMachine = data;
                createChart();
            });
        })
        d3.select("#materialSelectButton").on("change", function (d) {
            loadCuttingSpeeds();
        });
        d3.select("#toolSelectButton").on("change", function (d) {
            loadCuttingSpeeds();
        });
    </script>
</body>

</html>